---
title: "Comparison of predictions"
author: "Karla Monterrubio-GÃ³mez, Nathan Constantine-Cooke, and Catalina Vallejos"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: yes
    css: style.css
    theme: simplex
    highlight: textmate
    includes:
      in_header: head.html
      before_body: navbar.html
    self_contained: false
    toc_float:
      collapsed: no
link-citations: yes
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```


# Loading predictions

Here, we load the predicted probabilities of observing an event of type 1 by
$t=5$ that were obtained by different methods

```{r load_pred}
if (file.exists("/.dockerenv")){
  pred_CS <- read.csv("/Outputs/pred_CS.csv")
  pred_CIF <- read.csv("/Outputs/pred_CIF.csv")
  pred_Others <- read.csv("/Outputs/pred_Others.csv")
  pred_BART <- read.csv("/Outputs/pred_BART.csv")
} else {
  pred_CS <- read.csv("../Outputs/pred_CS.csv")
  pred_CIF <- read.csv("../Outputs/pred_CIF.csv")
  pred_Others <- read.csv("../Outputs/pred_Others.csv")
  pred_BART <- read.csv("../Outputs/pred_BART.csv")
}

pred_all <- merge(pred_CS, pred_CIF, by = "testID")
pred_all <- merge(pred_all, pred_Others, by = "testID")
pred_all <- merge(pred_all, pred_BART, by = "testID")

names(pred_all)
```

The data above includes predictions obtained using the following methods:

* `coxph_riskRegression`: Cause-specific Cox PH (CS Cox) model 
* `coxphPL_riskRegression`: Cause-specific Cox PH (CS Cox) model using a product
limit (PL) approach to calculated predicted probabilities. The latter ensures
that (in the limit) the event-specific probabilities sum up to 1 across events. 
* `FG_riskRegression`: Fine & Gray (F&G) regression   
* `DirectBinomial`: Direct binomial        
* `DPWeibull`: Dependent Dirichlet Process        
* `RF_logrankCR`: Random Forests (RF) using a modified Gray's criteria as the 
splitting rule, focusing on the first event type. The latter aims to identify 
covariates that affect the CIF for the first event type.
* `RF_logrankCR.av`: as above, but the splitting rule considers the average 
between the first and second event types.
* `crisk2.bart`: BART using its first formulation    
* `crisk2.bart_dart`: DART - a variation of BART (first formulation) that
enables feature selection
* `crisk.bart`: BART using its second formulation    

# Comparing predictions at $t=5$

As shown below, all methods led to correlated predictions. The greatest similarity was between the classical approaches:

similarity between methods based on the CIF specification
(Fine and Gray regression, direct binomial and DPWeibull). The three BART 
variations also led to similar predictions (discrepancies may be due to lack
of convergence). 

```{r, fig.width=12, fig.height=12}
library(GGally)

# Code to control axis limits was adapted from: https://stackoverflow.com/questions/53277656/how-to-define-facet-axis-limits-in-ggpairs-function
scatter_limitRange <- function(data, mapping, ...) { 
  ggplot(data = data, mapping = mapping, ...) + 
    geom_point(..., col = "#1A5276", alpha = 0.5) + 
    geom_abline(intercept = 0, slope = 1) +
    scale_x_continuous(limits = c(min(pred_all[,-1]), max(pred_all[,-1]))) +
    scale_y_continuous(limits = c(min(pred_all[,-1]), max(pred_all[,-1]))) +
    theme_classic()
}
dens_limitRange <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping, ...) + 
    geom_density(..., col = "#1A5276", fill = "#1A5276") + 
    scale_x_continuous(limits = c(min(pred_all[,-1]), max(pred_all[,-1]))) +
    theme_classic()
}

my.labels <- c("CS Cox", "CS Cox (PL)", "F&G", "Direct Binomial", 
               "DPWeibull", "RF logrankCR (1)", "RF logrankCR (av)", 
               "BART (1)", "DART (1)", "BART (2)")

ggpairs(pred_all, columns = 2:11, progress = FALSE,
        lower = list(continuous = scatter_limitRange),
        diag = list(continuous = dens_limitRange),
        columnLabels = my.labels)

if (file.exists("/.dockerenv")){ # running in docker
  ggsave("/Outputs/Comparison_predictions_t5.pdf", device = "pdf")
} else {
  ggsave("../Outputs/Comparison_predictions_t5.pdf", device = "pdf")
}
```

To evaluate the predictive performance for each methods, users can follow the
examples provided by [van Geloven et al](https://github.com/survival-lumc/ValidationCompRisks).

# References
<div id="refs"></div>

# Session Info
```{r}
sessionInfo()
```

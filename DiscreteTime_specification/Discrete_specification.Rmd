---
title: "Approaches based on a discrete survival times specification"
author: "Karla Monterrubio-Gómez, Nathan Constantine-Cooke, and Catalina Vallejos"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: yes
    css: style.css
    theme: simplex
    highlight: textmate
    toc_float:
      collapsed: no
link-citations: yes
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



# Dataset

In order to demonstrate the methods, we employ publicly available data. 

The dataset used here corresponds to the Hodgkin’s disease (HD) study described
in Pintilie, 2006. The dataset comprises 865 patients diagnosed with early stage
(I or II) HD, and which were treated either with radiation (RT) or with
radiation and chemotherapy (CMT).

The recorded data includes:

* age: Age (years)
* sex: Sex, F=female and M=Male.
* trtgiven: Treatment given, RT=Radiation, CMT=Chemotherapy and radiation
* medwidsi: Size of mediastinum involvement, N=No, S=Small, L=Large
* extranod: Extranodal disease, Y=Extranodal disease, N= Nodal disease
* clinstg: Clinical stage, 1=Stage I, 2=Stage II
* time: time to failure (years) calculated from the date of diagnosis
* status: 0=censoring, 1=relapse and 2=death.

We now load and display the structure of the HD dataset:

```{r, message=FALSE, warning=FALSE}
library(readr)
hd <- data.frame(read_csv("../Data/HD/hd.csv",
                          col_types = cols(X1 = col_skip())))
str(hd)
```

To proceed with the analysis, it is important to change the data type of sex,
trtgiven, medwidsi, and extranod from character to factor. Similarly, we convert
clinstg from numeric to factor.

```{r}
hd$sex      <- as.factor(hd$sex)
hd$trtgiven <- as.factor(hd$trtgiven)
hd$medwidsi <- as.factor(hd$medwidsi)
hd$extranod <- as.factor(hd$extranod)
hd$clinstg  <- as.factor(hd$clinstg)
```

Now, we explore the number of events for each event type:

```{r}
table(hd$status)
```

Thus, we have 439 censored patients, 291 with relapse, and 135 who died. From
now on, we assume that the event of interest is relapse, i.e. status=1.

In order to create a test set, we use stratified sampling to partition our
dataset into 80% for train and 20% for test.

```{r, eval=FALSE}
library(splitstackshape)
split_data <- stratified(hd, c("status"), 0.8, bothSets = TRUE)
hd_train   <- split_data$SAMP1
hd_test    <- split_data$SAMP2
```


```{r, echo=FALSE}
hd_train <- read_csv("../Data/HD/hd_train.csv", show_col_types = FALSE)[, -1]
hd_test <- read_csv("../Data/HD/hd_test.csv", show_col_types = FALSE)[, -1]

hd_train$sex      <- as.factor(hd_train$sex)
hd_train$trtgiven <- as.factor(hd_train$trtgiven)
hd_train$medwidsi <- as.factor(hd_train$medwidsi)
hd_train$extranod <- as.factor(hd_train$extranod)
hd_train$clinstg  <- as.factor(hd_train$clinstg)

hd_test$sex      <- as.factor(hd_test$sex)
hd_test$trtgiven <- as.factor(hd_test$trtgiven)
hd_test$medwidsi <- as.factor(hd_test$medwidsi)
hd_test$extranod <- as.factor(hd_test$extranod)
hd_test$clinstg  <- as.factor(hd_test$clinstg)
```

Now, we explore the number of observations per status in both train and test
set:

```{r}
table(hd_train$status)
table(hd_test$status)
```

# BART
In this section we show how to employ a Bayesian additive regression trees model for CR. A complete vignette is available at

## Model formulation 1
This approach models the time to the first event and then the conditional probability of the event being of type $k=1$ given that it occurred.
In order to fit the model, we first construct a model matrix, for both, train and test data. Then, the model is fitted with the function `crisk2.bart`. Note that the required binary event indicators $y_{ijk}$ can be constructed beforehand with `surv.pre.bart` and passed to the function using the `y.train` argument. Instead, here we pass arguments `times` and `delta` which will construct event indicators internally. 


```{r, results='hide'}
library(nnet)
library(survival)
library(BART)
library(stats)

xtrain = model.matrix(~. , hd_train[,c(1:6)])[,-1]
xtest = model.matrix(~. , hd_test[,c(1:6)])[,-1]


bart1 <- crisk2.bart(x.train = xtrain, 
                     times = hd_train$time, # needed if ytrain is not provided
                     delta = hd_train$status, # needed if ytrain is not provided
                     x.test = xtest, 
                     sparse = FALSE,    #set equal TRUE for variable selection 
                     type = 'pbart',
                     ntree = 30, numcut = 100, 
                     ndpost = 1000, nskip = 250, keepevery = 10L, printevery = 100L, 
                     seed = 99)  
```
The output contains 
The function `mc.crisk2.bart` permits parallel computation of the model.



Below, we re-organised the predicted CIF for cause 1 for the test dataset. The constructed matrix contains one row per subject and the columns correspond to the unique time points at which it is evaluated.
```{r}
cif.pred <- matrix(bart1$cif.test.mean, nrow=nrow(xtest), byrow = TRUE )
```
We show CIF curves for patient 1 (red) and 3 (blue) in the test set:
```{r, fig.dim=c(6,4)}
par(mar = c(4, 4, 2, 0.1))

plot(bart1$times,
     cif.pred[1,],
     type = "l",
     col = "red",
     ylim = c(0, 0.5),
     xlab = "Time (years)",
     ylab = "Cumulative incidence")
lines(bart1$times,  cif.pred[3,], col="blue")
```
Similarly, we can also obtain survival estimates. Below, we show estimates at $t=30.5$ for the first 5 subjects in the test set:
```{r}
surv.pred <- matrix(bart1$surv.test.mean, nrow=nrow(xtest), byrow = TRUE )
surv.pred[1:5,which(bart1$times == 30.5)]
```

## Model formulation 2
The second formulation employs one model for the conditional probability of experiencing event type $k=1$ at a specific time $t_j$ given that the subject is still at risk and a second model for the conditional probability of a type $k=2$ event at time $t_j$ given that the subject is still at risk and that it has not experience a type $k=1$ event.

As in the previous formulation, we first construct a model matrix and permit the function `crisk.bart` to do an internal call to construct the required event indicators:
```{r, results='hide'}
xtrain = model.matrix(~. , hd_train[,c(1:6)])[,-1]
xtest = model.matrix(~. , hd_test[,c(1:6)])[,-1]

bart2 <- crisk.bart(x.train = xtrain, times = hd_train$time, delta=hd_train$status,
           x.test = xtest, 
           sparse=FALSE, 
           type='pbart',
           ntree = 30, numcut = 100, 
           ndpost = 1000, nskip = 250, keepevery = 10L, printevery = 100L, 
           seed=99)
# Parallel computation of the model is available using mc.crisk.bart
```
The output is similar to that shown in the previous section.



# Session Info
```{r}
sessionInfo()
```